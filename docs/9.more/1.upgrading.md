---
title: Upgrading
---

## Upgrading to v7

### Updating your composer.json

1. If your `composer.json` contains any of the additional Mailcoach packages, you can safely remove them. They are now included in the core `laravel-mailcoach` package.
2. Update the requirement of `spatie/laravel-mailcoach` to `^7.0`
3. `laravel/sanctum` is no longer a requirement for Mailcoach. If you are not using this inside your application, make sure `config/sanctum.php` is removed.


#### Packages safe to remove
```json
{
    "require": {
        "spatie/laravel-mailcoach-editor": "^2.0",
        "spatie/laravel-mailcoach-mailgun-feedback": "^5.0",
        "spatie/laravel-mailcoach-mailgun-setup": "^1.0",
        "spatie/laravel-mailcoach-markdown-editor": "^2.0",
        "spatie/laravel-mailcoach-monaco": "^3.0",
        "spatie/laravel-mailcoach-postmark-feedback": "^5.0",
        "spatie/laravel-mailcoach-postmark-setup": "^1.0",
        "spatie/laravel-mailcoach-sendgrid-feedback": "^5.0",
        "spatie/laravel-mailcoach-sendgrid-setup": "^1.0",
        "spatie/laravel-mailcoach-sendinblue-feedback": "^1.0",
        "spatie/laravel-mailcoach-sendinblue-setup": "^1.0",
        "spatie/laravel-mailcoach-ses-feedback": "^5.0",
        "spatie/laravel-mailcoach-ses-setup": "^1.0",
        "spatie/laravel-mailcoach-unlayer": "^3.0",       
    }
}
```

### Clear your view cache

````shell
php artisan view:clear
````

### Encryption has been removed

Mailcoach no longer supports encrypting the data of subscribers. This caused too many issues with Mailcoach features.

Be sure to decrypt your subscribers table before migrating to v7.

### Removed `User` model

Mailcoach no longer provides a `User` model of its own. You can now extend the default Laravel model instead and implement our `MailcoachUser` interface:

```php
- use \Spatie\Mailcoach\Domain\Settings\Models\User as MailcoachUserModel;
+ use Illuminate\Foundation\Auth\User as Authenticatable;
+ use Spatie\Mailcoach\Domain\Settings\Models\MailcoachUser;

- class User extends MailcoachUserModel
+ class User extends Authenticatable implements MailcoachUser

+ public function canViewMailcoach(): bool
+ {
+     return true;
+ }
```

Inside the `canViewMailcoach()` method you can add additional checks if needed for your use-case.

### Config changes

There have been numerous config changes, you can view the full diff here: https://github.com/spatie/laravel-mailcoach/pull/1360/files#diff-9d9b7f6229b3a9808fbc42a2f3f8018eff635004bb814bebd37cf1e39c081746

The easiest way to update this is to run

```shell
php artisan vendor:publish --tag=mailcoach-config --force
```

And re-apply any changes you made previously to the config.

### View changes

Some views have changed considerably, take a look at the PR diff here: https://github.com/spatie/laravel-mailcoach/pull/1360/files

The easiest way to update this is to run

```shell
php artisan vendor:publish --tag=mailcoach-views --force
```

And re-apply any changes you made previously to the views.

### Livewire namespace has moved

If you have extended any Mailcoach Livewire components, their namespace has been moved from

```php
Spatie\Mailcoach\Http\Livewire
```

to

```php
Spatie\Mailcoach\Livewire
```

### A number of classes have been renamed or moved:

| Old                                                        | New                                                       |
|------------------------------------------------------------|-----------------------------------------------------------|
| \Spatie\Mailcoach\Http\App\Middleware\SetMailcoachDefaults | Spatie\Mailcoach\Http\App\Middleware\BootstrapMailcoach   |
| \Spatie\Mailcoach\Domain\Campaign\Policies\TemplatePolicy  | \Spatie\Mailcoach\Domain\Template\Policies\TemplatePolicy |
| \Spatie\Mailcoach\Domain\Campaign\Models\Template          | \Spatie\Mailcoach\Domain\Template\Models\Template         |

## Migrations

Like with previous upgrades, we've supplied a migration that will update all the necessary columns and move over any existing data.

Unlike previous upgrades, we suggest doing this upgrade in 3 steps:

> **warning**
> Make sure to take a backup before running any migrations or commands.

### 1. Adding new columns

```php
return new class extends \Illuminate\Database\Migrations\Migration
{
    public function up()
    {
        Schema::table('mailcoach_tag_segments', function (Blueprint $table) {
            $table->json('stored_conditions')->nullable()->after('email_list_id');
        });
    
        Schema::table('mailcoach_campaigns', function (Blueprint $table) {
            $table->boolean('disable_webview')->default(false)->after('show_publicly');
    
            $table->after('summary_mail_sent_at', function (Blueprint $table) {
                $table->integer('split_test_wait_time_in_minutes')->nullable();
                $table->integer('split_test_split_size_percentage')->nullable();
                $table->timestamp('split_test_started_at')->nullable();
                $table->foreignId('split_test_winning_content_item_id')->nullable();
            });
        });
    
        Schema::table('mailcoach_sends', function (Blueprint $table) {
            $table->foreignId('content_item_id')
                ->nullable()
                ->after('transport_message_id');
        });
    
        Schema::table('mailcoach_transactional_mail_log_items', function (Blueprint $table) {
            $table->boolean('fake')->default(false)->after('attachments');
        });
    
        Schema::create('mailcoach_content_items', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
    
            $table->morphs('model');
    
            $table->string('from_email')->nullable();
            $table->string('from_name')->nullable();
    
            $table->string('reply_to_email')->nullable();
            $table->string('reply_to_name')->nullable();
    
            $table->string('subject')->nullable();
    
            $table->unsignedBigInteger('template_id')->nullable();
            $table->longText('html')->nullable();
            $table->longText('structured_html')->nullable();
            $table->longText('email_html')->nullable();
            $table->longText('webview_html')->nullable();
    
            $table->string('mailable_class')->nullable();
            $table->json('mailable_arguments')->nullable();
    
            $table->boolean('utm_tags')->default(false);
            $table->string('utm_source')->nullable();
            $table->string('utm_medium')->nullable();
            $table->string('utm_campaign')->nullable();
            $table->boolean('add_subscriber_tags')->default(false);
            $table->boolean('add_subscriber_link_tags')->default(false);
    
            $table->timestamp('all_sends_created_at')->nullable();
            $table->timestamp('all_sends_dispatched_at')->nullable();
    
            $table->integer('sent_to_number_of_subscribers')->default(0);
            $table->integer('open_count')->default(0);
            $table->integer('unique_open_count')->default(0);
            $table->integer('open_rate')->default(0);
            $table->integer('click_count')->default(0);
            $table->integer('unique_click_count')->default(0);
            $table->integer('click_rate')->default(0);
            $table->integer('unsubscribe_count')->default(0);
            $table->integer('unsubscribe_rate')->default(0);
            $table->integer('bounce_count')->default(0);
            $table->integer('bounce_rate')->default(0);
            $table->timestamp('statistics_calculated_at')->nullable();
    
            $table->timestamps();
        });
    
        Schema::create('mailcoach_links', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table
                ->foreignId('content_item_id')
                ->constrained('mailcoach_content_items')
                ->cascadeOnDelete();
    
            $table->string('url', 2048);
            $table->integer('click_count')->default(0);
            $table->integer('unique_click_count')->default(0);
            $table->nullableTimestamps();
        });
    
        Schema::create('mailcoach_clicks', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
    
            $table
                ->foreignId('send_id')
                ->constrained('mailcoach_sends')
                ->cascadeOnDelete();
    
            $table
                ->foreignId('link_id')
                ->constrained('mailcoach_links')
                ->cascadeOnDelete();
    
            $table
                ->foreignId('subscriber_id')
                ->nullable()
                ->constrained('mailcoach_subscribers')
                ->cascadeOnDelete();
    
            $table->nullableTimestamps();
        });
    
        Schema::create('mailcoach_opens', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
    
            $table
                ->foreignId('send_id')
                ->constrained('mailcoach_sends')
                ->cascadeOnDelete();
    
            $table
                ->foreignId('content_item_id')
                ->nullable()
                ->constrained('mailcoach_content_items')
                ->cascadeOnDelete();
    
            $table
                ->foreignId('subscriber_id')
                ->nullable()
                ->constrained('mailcoach_subscribers')
                ->cascadeOnDelete();
    
            $table->nullableTimestamps();
        });
    
        Schema::create('mailcoach_unsubscribes', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
    
            $table
                ->foreignId('content_item_id')
                ->constrained('mailcoach_content_items')
                ->cascadeOnDelete();
    
            $table
                ->foreignId('subscriber_id')
                ->constrained('mailcoach_subscribers')
                ->cascadeOnDelete();
    
            $table->timestamps();
        });
    
        Schema::create('mailcoach_subscriber_exports', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->string('status');
    
            $table
                ->foreignId('email_list_id')
                ->nullable()
                ->constrained('mailcoach_email_lists')
                ->cascadeOnDelete();
    
            $table->json('filters')->nullable();
            $table->integer('exported_subscribers_count')->default(0);
            $table->text('errors')->nullable();
            $table->timestamps();
        });
    
        Schema::create('mailcoach_suppressions', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->string('email')->unique();
            $table->string('reason');
            $table->timestamps();
        });
    }
}
```

### 2. Migrating data

We suggest running this in steps in either a migration or console command depending on what you're comfortable with.

```php
class MigrateToV7Command extends Command
{
    protected $signature = 'app:migrate-to-v7';

    protected $description = 'Migrate Mailcoach data to v7';

    public function handle()
    {
        $this->migrateSegments();
        $this->migrateCampaigns();
        $this->migrateAutomationMails();
        $this->migrateTransactionalMails();
        $this->migrateTransactionalMailLogItems();
        $this->migrateSends();
        $this->migrateCampaignOpens();
        $this->migrateCampaignLinks();
        $this->migrateCampaignUnsubscribes();
        $this->migrateAutomationMailOpens();
        $this->migrateAutomationMailLinks();
        $this->migrateAutomationMailUnsubscribes();
        $this->migrateTransactionalMailOpens();
        $this->migrateTransactionalMailClicks();
    }

    public function migrateSegments(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_segments')->count());
        $this->getOutput()->writeln('Migrating segments');

        DB::table('mailcoach_segments')->lazyById()->each(function ($segment) {
            $positiveTags = DB::table('mailcoach_positive_segment_tags')->where('segment_id', $segment->id)->get();
            $negativeTags = DB::table('mailcoach_negative_segment_tags')->where('segment_id', $segment->id)->get();

            $storedConditions = [];

            if ($positiveTags->count()) {
                $storedConditions[] = [
                    'value' => $positiveTags->pluck('tag_id')->values()->toArray(),
                    'condition_key' => 'subscriber_tags',
                    'comparison_operator' => $segment->all_positive_tags_required
                        ? ComparisonOperator::All
                        : ComparisonOperator::In,
                ];
            }

            if ($negativeTags->count()) {
                $storedConditions[] = [
                    'value' => $negativeTags->pluck('tag_id')->values()->toArray(),
                    'condition_key' => 'subscriber_tags',
                    'comparison_operator' => $segment->all_negative_tags_required
                        ? ComparisonOperator::None
                        : ComparisonOperator::NotIn,
                ];
            }

            DB::table('mailcoach_segments')
                ->where('id', $segment->id)
                ->update([
                    'stored_conditions' => json_encode($storedConditions),
                ]);

            $this->getOutput()->progressAdvance();
        });

        $this->getOutput()->progressFinish();
    }

    public function migrateCampaigns(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_campaigns')->count());
        $this->getOutput()->writeln('Migrating campaigns');

        DB::table('mailcoach_campaigns')->lazyById()->each(function ($row) {
            DB::table('mailcoach_content_items')->insert([
                'uuid' => Str::uuid(),
                'model_type' => (new Campaign())->getMorphClass(),
                'model_id' => $row->id,
                'from_email' => $row->from_email ?? null,
                'from_name' => $row->from_name ?? null,

                'reply_to_email' => $row->reply_to_email ?? null,
                'reply_to_name' => $row->reply_to_name ?? null,

                'subject' => $row->subject ?? null,
                'template_id' => $row->template_id ?? null,

                'html' => $row->html ?? null,
                'structured_html' => $row->structured_html ?? null,
                'email_html' => $row->email_html ?? null,
                'webview_html' => $row->webview_html ?? null,

                'mailable_class' => $row->mailable_class ?? null,
                'mailable_arguments' => $row->mailable_arguments ?? null,

                'utm_tags' => $row->utm_tags ?? false,
                'add_subscriber_tags' => $row->add_subscriber_tags ?? false,
                'add_subscriber_link_tags' => $row->add_subscriber_link_tags ?? false,

                'sent_to_number_of_subscribers' => $row->sent_to_number_of_subscribers,
                'open_count' => $row->open_count,
                'unique_open_count' => $row->unique_open_count,
                'open_rate' => $row->open_rate,
                'click_count' => $row->click_count,
                'unique_click_count' => $row->unique_click_count,
                'click_rate' => $row->click_rate,
                'unsubscribe_count' => $row->unsubscribe_count,
                'unsubscribe_rate' => $row->unsubscribe_rate,
                'bounce_count' => $row->bounce_count,
                'bounce_rate' => $row->bounce_rate,
                'statistics_calculated_at' => $row->statistics_calculated_at ?? null,
                'created_at' => $row->created_at,
                'updated_at' => $row->updated_at,
            ]);

            $this->getOutput()->progressAdvance();
        });

        $this->getOutput()->progressFinish();
    }

    public function migrateAutomationMails(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_automation_mails')->count());
        $this->getOutput()->writeln('Migrating automation mails');

        DB::table('mailcoach_automation_mails')->lazyById()->each(function ($row) {
            DB::table('mailcoach_content_items')->insert([
                'uuid' => Str::uuid(),
                'model_type' => (new AutomationMail())->getMorphClass(),
                'model_id' => $row->id,
                'from_email' => $row->from_email ?? null,
                'from_name' => $row->from_name ?? null,

                'reply_to_email' => $row->reply_to_email ?? null,
                'reply_to_name' => $row->reply_to_name ?? null,

                'subject' => $row->subject ?? null,
                'template_id' => $row->template_id ?? null,

                'html' => $row->html ?? null,
                'structured_html' => $row->structured_html ?? null,
                'email_html' => $row->email_html ?? null,
                'webview_html' => $row->webview_html ?? null,

                'mailable_class' => $row->mailable_class ?? null,
                'mailable_arguments' => $row->mailable_arguments ?? null,

                'utm_tags' => $row->utm_tags ?? false,
                'add_subscriber_tags' => $row->add_subscriber_tags ?? false,
                'add_subscriber_link_tags' => $row->add_subscriber_link_tags ?? false,

                'sent_to_number_of_subscribers' => $row->sent_to_number_of_subscribers,
                'open_count' => $row->open_count,
                'unique_open_count' => $row->unique_open_count,
                'open_rate' => $row->open_rate,
                'click_count' => $row->click_count,
                'unique_click_count' => $row->unique_click_count,
                'click_rate' => $row->click_rate,
                'unsubscribe_count' => $row->unsubscribe_count,
                'unsubscribe_rate' => $row->unsubscribe_rate,
                'bounce_count' => $row->bounce_count,
                'bounce_rate' => $row->bounce_rate,
                'statistics_calculated_at' => $row->statistics_calculated_at ?? null,
                'created_at' => $row->created_at,
                'updated_at' => $row->updated_at,
            ]);

            $this->getOutput()->progressAdvance();
        });

        $this->getOutput()->progressFinish();
    }

    public function migrateTransactionalMails(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_transactional_mails')->count());
        $this->getOutput()->writeln('Migrating transactional mails');

        DB::table('mailcoach_transactional_mails')
            ->lazyById()
            ->each(function ($row) {
                DB::table('mailcoach_content_items')->insert([
                    'uuid' => $row->uuid,
                    'model_id' => $row->id,
                    'model_type' => (new TransactionalMail())->getMorphClass(),
                    'subject' => $row->subject,
                    'template_id' => $row->template_id,
                    'html' => $row->body,
                    'structured_html' => $row->structured_html,
                ]);

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateTransactionalMailLogItems(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_transactional_mail_log_items')->count());
        $this->getOutput()->writeln('Migrating transactional mail log items');

        DB::table('mailcoach_transactional_mail_log_items')
            ->lazyById()
            ->each(function ($row) {
                DB::table('mailcoach_content_items')->insert([
                    'uuid' => $row->uuid,
                    'model_id' => $row->id,
                    'model_type' => (new TransactionalMailLogItem)->getMorphClass(),
                    'subject' => $row->subject,
                    'html' => $row->body,
                    'structured_html' => $row->structured_html,
                    'mailable_class' => $row->mailable_class,
                ]);

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateSends(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_sends')->whereNull('content_item_id')->count());
        $this->getOutput()->writeln('Migrating sends');

        DB::table('mailcoach_sends')
            ->whereNull('content_item_id')
            ->lazyById()
            ->each(function ($row) {
                $contentItem = match (true) {
                    ! is_null($row->campaign_id) => DB::table('mailcoach_content_items')->where('model_id', $row->campaign_id)->where('model_type', (new Campaign)->getMorphClass())->first(),
                    ! is_null($row->automation_mail_id) => DB::table('mailcoach_content_items')->where('model_id', $row->automation_mail_id)->where('model_type', (new AutomationMail)->getMorphClass())->first(),
                    ! is_null($row->transactional_mail_log_item_id) => DB::table('mailcoach_content_items')->where('model_id', $row->transactional_mail_log_item_id)->where('model_type', (new TransactionalMailLogItem)->getMorphClass())->first(),
                    default => throw new Exception('This send has no destination'),
                };

                if ($contentItem) {
                    DB::table('mailcoach_sends')->where('id', $row->id)->update(['content_item_id' => $contentItem->id]);
                }

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateCampaignOpens(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_campaign_opens')->count());
        $this->getOutput()->writeln('Migrating campaign opens');

        DB::table('mailcoach_campaign_opens')
            ->join('mailcoach_content_items', 'mailcoach_content_items.model_id', '=', 'mailcoach_campaign_opens.campaign_id')
            ->select('mailcoach_campaign_opens.*', DB::raw('mailcoach_content_items.id as content_item_id'))
            ->where('mailcoach_content_items.model_type', (new Campaign())->getMorphClass())
            ->orderBy('mailcoach_campaign_opens.id')
            ->lazy()
            ->each(function ($row) {
                DB::table('mailcoach_opens')->insert([
                    'uuid' => $row->uuid,
                    'send_id' => $row->send_id,
                    'content_item_id' => $row->content_item_id,
                    'subscriber_id' => $row->subscriber_id,
                    'created_at' => $row->created_at,
                    'updated_at' => $row->updated_at,
                ]);

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateCampaignLinks(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_campaign_links')->count());
        $this->getOutput()->writeln('Migrating campaign links');

        DB::table('mailcoach_campaign_links')
            ->join('mailcoach_content_items', 'mailcoach_content_items.model_id', '=', 'mailcoach_campaign_links.campaign_id')
            ->where('mailcoach_content_items.model_type', (new Campaign)->getMorphClass())
            ->select('mailcoach_campaign_links.*', DB::raw('mailcoach_content_items.id as content_item_id'))
            ->orderBy('mailcoach_campaign_links.id')
            ->lazy()
            ->each(function ($row) {
                $linkId = DB::table('mailcoach_links')->insertGetId([
                    'uuid' => $row->uuid,
                    'content_item_id' => $row->content_item_id,
                    'url' => $row->url,
                    'click_count' => $row->click_count,
                    'unique_click_count' => $row->unique_click_count,
                    'created_at' => $row->created_at,
                    'updated_at' => $row->updated_at,
                ]);

                DB::table('mailcoach_campaign_clicks')
                    ->where('campaign_link_id', $row->id)
                    ->lazyById()
                    ->each(function ($click) use ($linkId) {
                        DB::table('mailcoach_clicks')->insert([
                            'uuid' => $click->uuid,
                            'send_id' => $click->send_id,
                            'link_id' => $linkId,
                            'subscriber_id' => $click->subscriber_id,
                            'created_at' => $click->created_at,
                            'updated_at' => $click->updated_at,
                        ]);
                    });

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateCampaignUnsubscribes(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_campaign_unsubscribes')->count());
        $this->getOutput()->writeln('Migrating campaign unsubscribes');

        DB::table('mailcoach_campaign_unsubscribes')
            ->join('mailcoach_content_items', 'mailcoach_content_items.model_id', '=', 'mailcoach_campaign_unsubscribes.campaign_id')
            ->where('mailcoach_content_items.model_type', (new Campaign)->getMorphClass())
            ->select('mailcoach_campaign_unsubscribes.*', DB::raw('mailcoach_content_items.id as content_item_id'))
            ->orderBy('mailcoach_campaign_unsubscribes.id')
            ->lazy()
            ->each(function ($row) {
                DB::table('mailcoach_unsubscribes')->insert([
                    'uuid' => $row->uuid,
                    'content_item_id' => $row->content_item_id,
                    'subscriber_id' => $row->subscriber_id,
                    'created_at' => $row->created_at,
                    'updated_at' => $row->updated_at,
                ]);

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateAutomationMailOpens(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_automation_mail_opens')->count());
        $this->getOutput()->writeln('Migrating automation mail opens');

        DB::table('mailcoach_automation_mail_opens')
            ->join('mailcoach_content_items', 'mailcoach_content_items.model_id', '=', 'mailcoach_automation_mail_opens.automation_mail_id')
            ->select('mailcoach_automation_mail_opens.*', DB::raw('mailcoach_content_items.id as content_item_id'))
            ->where('mailcoach_content_items.model_type', (new AutomationMail)->getMorphClass())
            ->orderBy('mailcoach_automation_mail_opens.id')
            ->lazy()
            ->each(function ($row) {
                try {
                    DB::table('mailcoach_opens')->insert([
                        'uuid' => $row->uuid,
                        'send_id' => $row->send_id,
                        'content_item_id' => $row->content_item_id,
                        'subscriber_id' => $row->subscriber_id,
                        'created_at' => $row->created_at,
                        'updated_at' => $row->updated_at,
                    ]);
                } catch (\Throwable) {
                }

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateAutomationMailLinks(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_automation_mail_links')->count());
        $this->getOutput()->writeln('Migrating automation mail links');

        DB::table('mailcoach_automation_mail_links')
            ->join('mailcoach_content_items', 'mailcoach_content_items.model_id', '=', 'mailcoach_automation_mail_links.automation_mail_id')
            ->where('mailcoach_content_items.model_type', (new AutomationMail)->getMorphClass())
            ->select('mailcoach_automation_mail_links.*', DB::raw('mailcoach_content_items.id as content_item_id'))
            ->orderBy('mailcoach_automation_mail_links.id')
            ->lazy()
            ->each(function ($row) {
                $linkId = DB::table('mailcoach_links')->insertGetId([
                    'uuid' => $row->uuid,
                    'content_item_id' => $row->content_item_id,
                    'url' => $row->url,
                    'click_count' => $row->click_count,
                    'unique_click_count' => $row->unique_click_count,
                    'created_at' => $row->created_at,
                    'updated_at' => $row->updated_at,
                ]);

                DB::table('mailcoach_automation_mail_clicks')
                    ->where('automation_mail_link_id', $row->id)
                    ->lazyById()
                    ->each(function ($click) use ($linkId) {
                        DB::table('mailcoach_clicks')->insert([
                            'uuid' => $click->uuid,
                            'send_id' => $click->send_id,
                            'link_id' => $linkId,
                            'subscriber_id' => $click->subscriber_id,
                            'created_at' => $click->created_at,
                            'updated_at' => $click->updated_at,
                        ]);
                    });

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateAutomationMailUnsubscribes(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_automation_mail_unsubscribes')->count());
        $this->getOutput()->writeln('Migrating automation mail unsubscribes');

        DB::table('mailcoach_automation_mail_unsubscribes')
            ->join('mailcoach_content_items', 'mailcoach_content_items.model_id', '=', 'mailcoach_automation_mail_unsubscribes.automation_mail_id')
            ->where('mailcoach_content_items.model_type', (new AutomationMail)->getMorphClass())
            ->select('mailcoach_automation_mail_unsubscribes.*', DB::raw('mailcoach_content_items.id as content_item_id'))
            ->orderBy('mailcoach_automation_mail_unsubscribes.id')
            ->lazy()
            ->each(function ($row) {
                DB::table('mailcoach_unsubscribes')->insert([
                    'uuid' => $row->uuid,
                    'content_item_id' => $row->content_item_id,
                    'subscriber_id' => $row->subscriber_id,
                    'created_at' => $row->created_at,
                    'updated_at' => $row->updated_at,
                ]);

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateTransactionalMailOpens(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_transactional_mail_opens')->count());
        $this->getOutput()->writeln('Migrating transactional mail opens');

        DB::table('mailcoach_transactional_mail_opens')
            ->lazyById()
            ->each(function ($row) {
                try {
                    DB::table('mailcoach_opens')->insert([
                        'uuid' => $row->uuid,
                        'send_id' => $row->send_id,
                        'created_at' => $row->created_at,
                        'updated_at' => $row->updated_at,
                    ]);
                } catch (\Throwable) {
                }

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }

    public function migrateTransactionalMailClicks(): void
    {
        $this->getOutput()->progressStart(DB::table('mailcoach_transactional_mail_clicks')->count());
        $this->getOutput()->writeln('Migrating transactional_mail_clicks');

        DB::table('mailcoach_transactional_mail_clicks')
            ->join('mailcoach_sends', 'mailcoach_sends.id', '=', 'mailcoach_transactional_mail_clicks.send_id')
            ->select('mailcoach_transactional_mail_clicks.*', 'mailcoach_sends.content_item_id')
            ->orderBy('mailcoach_transactional_mail_clicks.id')
            ->lazy()
            ->each(function ($row) {
                $existing = DB::table('mailcoach_links')
                    ->where('content_item_id', $row->content_item_id)
                    ->where('url', $row->url)
                    ->first()
                    ?->id;

                if ($existing) {
                    DB::table('mailcoach_links')->where('id', $existing)->increment('click_count');
                } else {
                    $existing = DB::table('mailcoach_links')->insertGetId([
                        'uuid' => Str::uuid(),
                        'content_item_id' => $row->content_item_id,
                        'url' => $row->url,
                        'click_count' => 1,
                        'unique_click_count' => 1,
                    ]);
                }

                DB::table('mailcoach_clicks')->insert([
                    'uuid' => $row->uuid,
                    'send_id' => $row->send_id,
                    'link_id' => $existing,
                    'created_at' => $row->created_at,
                    'updated_at' => $row->updated_at,
                ]);

                $this->getOutput()->progressAdvance();
            });

        $this->getOutput()->progressFinish();
    }
}
```

### 3. Remove old columns and data

> *warning*
> Be sure to verify that the data migration ran successfully and Mailcoach v7 is working correctly before running this migration. 

```php
return new class extends \Illuminate\Database\Migrations\Migration
{
    public function up()
    {
        Schema::table('mailcoach_segments', function (Blueprint $table) {
            $table->dropColumn(['all_positive_tags_required', 'all_negative_tags_required']);
        });

        Schema::table('mailcoach_campaigns', function (Blueprint $table) {
            $table->dropColumn([
                'from_email',
                'from_name',
                'reply_to_email',
                'reply_to_name',
                'subject',
                'template_id',
                'html',
                'structured_html',
                'email_html',
                'webview_html',
                'mailable_class',
                'mailable_arguments',
                'utm_tags',
                'sent_to_number_of_subscribers',
                'add_subscriber_tags',
                'add_subscriber_link_tags',
                'open_count',
                'unique_open_count',
                'open_rate',
                'click_count',
                'unique_click_count',
                'click_rate',
                'unsubscribe_count',
                'unsubscribe_rate',
                'bounce_count',
                'bounce_rate',
                'statistics_calculated_at',
                'last_modified_at',
                'all_sends_created_at',
                'all_sends_dispatched_at',
            ]);
        });

        Schema::table('mailcoach_automation_mails', function (Blueprint $table) {
            $table->dropColumn([
                'from_email',
                'from_name',
                'reply_to_email',
                'reply_to_name',
                'subject',
                'template_id',
                'html',
                'structured_html',
                'email_html',
                'webview_html',
                'mailable_class',
                'mailable_arguments',
                'utm_tags',
                'sent_to_number_of_subscribers',
                'add_subscriber_tags',
                'add_subscriber_link_tags',
                'open_count',
                'unique_open_count',
                'open_rate',
                'click_count',
                'unique_click_count',
                'click_rate',
                'unsubscribe_count',
                'unsubscribe_rate',
                'bounce_count',
                'bounce_rate',
                'statistics_calculated_at',
                'last_modified_at',
            ]);
        });

        Schema::table('mailcoach_transactional_mail_log_items', function (Blueprint $table) {
            $table->dropColumn([
                'subject',
                'body',
                'structured_html',
            ]);
        });

        Schema::table('mailcoach_sends', function (Blueprint $table) {
            $table->dropColumn([
                'campaign_id',
                'automation_mail_id',
                'transactional_mail_log_item_id',
            ]);
        });

        Schema::drop('mailcoach_positive_segment_tags');
        Schema::drop('mailcoach_negative_segment_tags');

        Schema::drop('mailcoach_campaign_links');
        Schema::drop('mailcoach_campaign_clicks');
        Schema::drop('mailcoach_campaign_opens');
        Schema::drop('mailcoach_campaign_unsubscribes');
        Schema::drop('mailcoach_automation_mail_links');
        Schema::drop('mailcoach_automation_mail_clicks');
        Schema::drop('mailcoach_automation_mail_opens');
        Schema::drop('mailcoach_automation_mail_unsubscribes');

        Schema::drop('mailcoach_transactional_mail_clicks');
        Schema::drop('mailcoach_transactional_mail_opens');
    }
}
```


## Upgrading to v6

This version adds numerous new features and a completely new look to Mailcoach.

Some notable features:

- Completely new design with improved UX
- Add & manage multiple mailers with different providers with automatic setup
- Show a website archive of your email list's campaigns
- A full-featured template system
- A new & improved Markdown editor
- Send outgoing webhooks
- Improved list insights & charts
- A new "Manage preferences" screen where subscribers can manage the (public) tags attached to them
- A command palette
- Automations can be configured to run more than once for a subscriber
- The ability to override, replace and extend every page of Mailcoach

### Updating your composer.json

- If your `composer.json` contains `spatie/mailcoach-ui`, you can remove this as it's now included within the core `laravel-mailcoach` package.
- Update the requirement of `spatie/laravel-mailcoach` to `^6.0`
- Mailcoach now requires PHP 8.1, so make sure to update that requirement as well

```json
"require": {
-     "php": "^8.0",
+     "php": "^8.1",
    "fruitcake/laravel-cors": "^2.0.5",
    "guzzlehttp/guzzle": "^7.2",
    "laravel/framework": "^9.0",
    "laravel/horizon": "^5.9",
    "laravel/tinker": "^2.7",
-     "spatie/laravel-mailcoach": "^5.0",
+     "spatie/laravel-mailcoach": "^6.0",
-     "spatie/mailcoach-ui": "^5.0"
},
```

#### Composer scripts

- The composer hook command has been renamed, make sure to edit this in your `scripts` section if it is present, usually only in a standalone installation:
- The necessary migrations will now be published by the publish command

```json
"scripts": {
    "post-autoload-dump": [
        "Illuminate\\Foundation\\ComposerScripts::postAutoloadDump",
        "@php artisan package:discover --ansi"
    ],
    "post-root-package-install": [
        "@php -r \"file_exists('.env') || copy('.env.example', '.env');\""
    ],
    "post-create-project-cmd": [
        "@php artisan key:generate --ansi",
-         "@php artisan vendor:publish --tag mailcoach-migrations",
-         "@php artisan vendor:publish --tag mailcoach-ui-migrations",
        "@php artisan mailcoach:prepare-git-ignore",
-         "@php artisan mailcoach:execute-composer-hook"
+         "@php artisan mailcoach:publish"
    ],
    "post-update-cmd": [
-         "@php artisan mailcoach:execute-composer-hook",
+         "@php artisan mailcoach:publish",
        "@php artisan vendor:publish --tag=laravel-assets --ansi --force"
    ]
}
```

### Remove the mailcoach-ui routes

Mailcoach UI required separate routes to be registered, in the standalone version these are registered inside your `RouteServiceProvider`, you can remove these and replace them by the default Mailcoach route macro:

```php
public function boot()
{
    ...

-     Route::mailcoachUi('/');
+     Route::mailcoach('/');

    ...
}
```

After this, you can run a `composer update`

### Update your Schedule

There have been a few changes to the scheduled commands, make sure your Mailcoach commands in your `app/Console/Kernel.php` file look like this:

```php
protected function schedule(Schedule $schedule)
{
    $schedule->command('mailcoach:send-automation-mails')->everyMinute();
    $schedule->command('mailcoach:send-scheduled-campaigns')->everyMinute();
    $schedule->command('mailcoach:send-campaign-mails')->everyMinute();

    $schedule->command('mailcoach:run-automation-triggers')->everyMinute();
    $schedule->command('mailcoach:run-automation-actions')->everyMinute();

    $schedule->command('mailcoach:calculate-statistics')->everyMinute();
    $schedule->command('mailcoach:calculate-automation-mail-statistics')->everyMinute();
    $schedule->command('mailcoach:send-campaign-summary-mail')->hourly();
    $schedule->command('mailcoach:cleanup-processed-feedback')->hourly();
    $schedule->command('mailcoach:send-email-list-summary-mail')->mondays()->at('9:00');
    $schedule->command('mailcoach:delete-old-unconfirmed-subscribers')->daily();
}
```

Methods like `runInBackground()` and `withoutOverlapping()` are no longer necessary as we dispatch unique jobs inside the command instead.

#### Update the login route

Mailcoach has now prefixed its authentication routes, if you don't have any login route of your own, add the following to your `app/Exceptions/Handler.php`:

```php
protected function unauthenticated($request, AuthenticationException $exception)
{
    return $this->shouldReturnJson($request, $exception)
        ? response()->json(['message' => $exception->getMessage()], 401)
        : redirect()->guest($exception->redirectTo() ?? route('mailcoach.login'));
}
```


### Configuration updates

- Delete the `config/mailcoach-ui.php` file if present in your installation, be sure to port over any changes to the `config/mailcoach.php` config file.

A full diff of the config file [can be found here](https://github.com/spatie/laravel-mailcoach/compare/5.11.2...main#diff-9d9b7f6229b3a9808fbc42a2f3f8018eff635004bb814bebd37cf1e39c081746)

We recommend running `php artisan vendor:publish --tag=mailcoach-config --force` which will override your old configuration file with the new one. Using a git diff you can then re-apply any changes you previously made to your configuration file.

Notable changes to the config file are documented below:

#### Throttling

Throttling config is no longer set inside the Mailcoach configuration file, these settings [can be controlled for each mailer](/docs/self-hosted/v7/advanced-usage-for-php-devs/throttling-sends)

#### Welcome mails

Any configuration relating to welcome mails have been removed, you can now [create a welcome automation](/docs/self-hosted/v7/using-mailcoach/automations/creating-an-automation) instead.

#### Livewire

All views now use Livewire components which you can override in the config to add your own functionality if necessary.

#### Horizon

A schedule queue was added to Mailcoach, make sure your horizon config contains it:

```php
'mailcoach-general' => [
    'connection' => 'mailcoach-redis',
-     'queue' => ['general', 'mailcoach', 'mailcoach-feedback', 'send-mail', 'send-automation-mail'],
+     'queue' => ['general', 'mailcoach-schedule', 'mailcoach', 'mailcoach-feedback', 'send-mail', 'send-automation-mail'],
    'balance' => 'auto',
    'processes' => 10,
    'tries' => 2,
    'timeout' => 60 * 60,
],
```

If you're using simple balancing, make sure the schedule queue is defined early as that determines priority.

#### User model

If you use your own User model, make sure to replace the one in `config/mailcoach.php` with your own:

```php
'models' => [
    ...
-     'user' => \Spatie\Mailcoach\Domain\Settings\Models\User::class,
+     'user' => \App\Models\User::class,
    ...
]
```

The standalone starter project defined the Auth user model as `\Spatie\MailcoachUi\Models\User`, replace this with the new User model, or your own model in `config/auth.php`.

```php
'users' => [
    'driver' => 'eloquent',
-     'model' => Spatie\MailcoachUi\Models\User::class,
+     'model' => \Spatie\Mailcoach\Domain\Settings\Models\User::class,
],
```

### Views

Delete the `resources/views/vendor/mailcoach` folder if you did not have any changes made to the views.

Otherwise, we recommend deleting the folder anyway and re-publishing to port over any of your changes.

Run `php artisan view:clear` to delete any compiled views.

### Migration changes

There have been a few additions and changes to the Mailcoach tables, you can use the migration below to update your database:

Some notable changes:

- All models now have a UUID
- Custom confirmation mails now use transactional mails instead of raw html

Make sure you have `doctrine/dbal` installed in your app for rename migrations to work.

```shell
composer require doctrine/dbal
```

Below you can find the full upgrade to v6 migration, depending on how much data you have this could take a long time. It might be a good idea to split this up into separate migrations.

```php
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    public function up()
    {
        Schema::table('mailcoach_email_lists', function (Blueprint $table) {
            $table->unique('uuid');

            $table->foreignId('confirmation_mail_id')->after('requires_confirmation')->nullable();

            $table->after('allowed_form_extra_attributes', function (Blueprint $table) {
                $table->string('honeypot_field')->nullable();
                $table->boolean('has_website')->default(false);
                $table->boolean('show_subscription_form_on_website')->default(true);
                $table->string('website_slug')->nullable();
                $table->string('website_title')->nullable();
                $table->text('website_intro')->nullable();
                $table->string('website_primary_color')->nullable();
                $table->string('website_theme')->default('default');
                $table->text('website_subscription_description')->nullable();
            });

            $table->dropColumn([
                'confirmation_mail_subject',
                'confirmation_mail_content',
                'send_welcome_mail',
                'welcome_mail_subject',
                'welcome_mail_content',
                'welcome_mailable_class',
                'welcome_mail_delay_in_minutes',
            ]);
        });

        Schema::table('mailcoach_subscribers', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_segments', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
        });
        DB::table('mailcoach_segments')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_segments', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_campaigns', function (Blueprint $table) {
            $table->unique('uuid');
            $table->index('sent_at');
            $table->index(['scheduled_at', 'status']);

            $table->boolean('show_publicly')->after('subject')->default(true);
            $table->unsignedBigInteger('template_id')->after('email_list_id')->nullable();

            $table->after('segment_description', function (Blueprint $table) {
                $table->boolean('add_subscriber_tags')->default(false);
                $table->boolean('add_subscriber_link_tags')->default(false);
            });

            $table->dropColumn([
                'track_opens',
                'track_clicks',
            ]);
        });

        Schema::table('mailcoach_campaign_links', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
        });
        DB::table('mailcoach_campaign_links')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_campaign_links', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::rename('mailcoach_transactional_mails', 'mailcoach_transactional_mail_log_items');
        Schema::table('mailcoach_transactional_mail_log_items', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
            $table->json('attachments')->after('bcc')->nullable();

            $table->dropColumn([
                'track_opens',
                'track_clicks',
            ]);
        });
        DB::table('mailcoach_transactional_mail_log_items')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_transactional_mail_log_items', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_automation_mails', function (Blueprint $table) {
            $table->unique('uuid');
            $table->unsignedBigInteger('template_id')->after('subject')->nullable();

            $table->after('utm_tags', function (Blueprint $table) {
                $table->boolean('add_subscriber_tags')->default(false);
                $table->boolean('add_subscriber_link_tags')->default(false);
            });

            $table->dropColumn([
                'track_opens',
                'track_clicks',
            ]);
        });

        Schema::table('mailcoach_sends', function (Blueprint $table) {
            $table->renameColumn('transactional_mail_id', 'transactional_mail_log_item_id');
            $table->timestamp('invalidated_at')->after('sent_at')->nullable();

            $table->index('transport_message_id');
            $table->index(['sending_job_dispatched_at', 'sent_at'], 'sent_index');
        });

        Schema::table('mailcoach_campaign_clicks', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
        });
        DB::table('mailcoach_campaign_clicks')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_campaign_clicks', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_campaign_opens', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
        });
        DB::table('mailcoach_campaign_opens')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_campaign_opens', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_campaign_unsubscribes', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
        });
        DB::table('mailcoach_campaign_unsubscribes')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_campaign_unsubscribes', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_send_feedback_items', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
        });
        DB::table('mailcoach_send_feedback_items')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_send_feedback_items', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_templates', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
            $table->boolean('contains_placeholders')->after('name')->default(false);
        });
        DB::table('mailcoach_templates')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_templates', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_subscriber_imports', function (Blueprint $table) {
            $table->unique('uuid');
            $table->text('errors')->after('imported_subscribers_count')->nullable();

            $table->dropColumn('error_count');
        });

        Schema::table('mailcoach_tags', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
            $table->boolean('visible_in_preferences')->after('type')->default(false);
        });
        DB::table('mailcoach_tags')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_tags', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_email_list_subscriber_tags', function (Blueprint $table) {
            $table->index(['subscriber_id', 'tag_id'], 'subscriber_id_tag_id_index');
        });

        Schema::table('mailcoach_automations', function (Blueprint $table) {
            $table->unique('uuid');

            $table->after('interval', function (Blueprint $table) {
                $table->boolean('repeat_enabled')->default(false);
                $table->boolean('repeat_only_after_halt')->default(true);
            });
        });

        Schema::table('mailcoach_automation_actions', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_automation_triggers', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_automation_action_subscriber', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');

            $table->index('action_id');
            $table->index('subscriber_id');
        });
        DB::table('mailcoach_automation_action_subscriber')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_automation_action_subscriber', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_automation_mail_opens', function (Blueprint $table) {
            $table->uuid('uuid');
        });
        DB::table('mailcoach_automation_mail_opens')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_automation_mail_opens', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_automation_mail_links', function (Blueprint $table) {
            $table->uuid('uuid');
        });
        DB::table('mailcoach_automation_mail_links')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_automation_mail_links', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_automation_mail_clicks', function (Blueprint $table) {
            $table->uuid('uuid');
        });
        DB::table('mailcoach_automation_mail_clicks')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_automation_mail_clicks', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_automation_mail_unsubscribes', function (Blueprint $table) {
            $table->uuid('uuid');
        });
        DB::table('mailcoach_automation_mail_unsubscribes')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_automation_mail_unsubscribes', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_transactional_mail_opens', function (Blueprint $table) {
            $table->uuid('uuid')->index();
        });
        DB::table('mailcoach_transactional_mail_opens')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_transactional_mail_opens', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::table('mailcoach_transactional_mail_clicks', function (Blueprint $table) {
            $table->uuid('uuid');
        });
        DB::table('mailcoach_transactional_mail_clicks')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_transactional_mail_clicks', function (Blueprint $table) {
            $table->unique('uuid');
        });

        Schema::rename('mailcoach_transactional_mail_templates', 'mailcoach_transactional_mails');
        Schema::table('mailcoach_transactional_mails', function (Blueprint $table) {
            $table->uuid('uuid')->after('id');
            $table->unsignedBigInteger('template_id')->after('bcc')->nullable();

            $table->dropColumn([
                'track_opens',
                'track_clicks',
            ]);
        });
        DB::table('mailcoach_transactional_mails')->update([
            'uuid' => DB::raw('uuid()'),
        ]);
        Schema::table('mailcoach_transactional_mails', function (Blueprint $table) {
            $table->unique('uuid');        
        });

        if (! Schema::hasColumn('users', 'welcome_valid_until')) {
            Schema::table('users', function (Blueprint $table) {
                $table->timestamp('welcome_valid_until')->nullable();
            });
        }

        if (! Schema::hasTable('mailcoach_uploads')) {
            Schema::create('mailcoach_uploads', function (Blueprint $table) {
                $table->bigIncrements('id');
                $table->uuid('uuid')->unique();
                $table->timestamps();
            });
        } else {
            Schema::table('mailcoach_uploads', function (Blueprint $table) {
                $table->uuid('uuid')->after('id');
            });
            DB::table('mailcoach_uploads')->update([
                'uuid' => DB::raw('uuid()'),
            ]);
            Schema::table('mailcoach_uploads', function (Blueprint $table) {
                $table->unique('uuid');
            });
        }

        if (! Schema::hasTable('mailcoach_settings')) {
            Schema::create('mailcoach_settings', function (Blueprint $table) {
                $table->string('key')->index();
                $table->longText('value')->nullable();
            });
        }

        Schema::create('mailcoach_mailers', function (Blueprint $table) {
            $table->id();
            $table->uuid()->unique();
            $table->string('name');
            $table->string('config_key_name')->index();
            $table->string('transport');
            $table->longText('configuration')->nullable();
            $table->boolean('default')->default(false);
            $table->boolean('ready_for_use')->default(false);
            $table->timestamps();
        });

        Schema::create('mailcoach_webhook_configurations', function (Blueprint $table) {
            $table->id();
            $table->uuid()->unique();
            $table->string('name');
            $table->text('url');
            $table->string('secret');
            $table->boolean('use_for_all_lists')->default(true);
            $table->timestamps();
        });

        Schema::create('mailcoach_webhook_configuration_email_lists', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('webhook_configuration_id');
            $table->unsignedBigInteger('email_list_id');
            $table->timestamps();

            $table
                ->foreign('webhook_configuration_id', 'wc_idx')
                ->references('id')->on('mailcoach_webhook_configurations')
                ->cascadeOnDelete();

            $table
                ->foreign('email_list_id', 'mel_idx')
                ->references('id')->on('mailcoach_email_lists')
                ->cascadeOnDelete();
        });
        
        if (! Schema::hasColumn('personal_access_tokens', 'expires_at')) {
            Schema::table('personal_access_tokens', function (Blueprint $table) {
                $table->timestamp('expires_at')->after('last_used_at')->nullable();
            });
        }
    }
};
```

If you're already using Laravel MediaLibrary make sure that the `media` table in your project has the same fields as the `media` migration included with Mailcoach.

### Open & Click tracking

The Campaign, AutomationMail and TransactionalMail no longer have the ability to enable/disable open & click tracking.

This is because this is a setting at the provider level that Mailcoach has no direct control over. You could disable tracking in Mailcoach but still have tracking links & pixels present because the settings was enabled at your provider.

When setting up mailers through the new mailer UI, Mailcoach will make the necessary API calls to enable/disable tracking for that provider.

### Transactional models renamed

The `Spatie\Mailcoach\Domain\TransactionalMail\Models\TransactionalMail` model has been renamed to `Spatie\Mailcoach\Domain\TransactionalMail\Models\TransactionalMailLogItem`

The `Spatie\Mailcoach\Domain\TransactionalMail\Models\TransactionalMailTemplate` model has been renamed to `Spatie\Mailcoach\Domain\TransactionalMail\Models\TransactionalMail` 

Make sure to rename these in the correct order if you reference these inside your application.

### Translations

We've reworked how Mailcoach translations work, if you had published them make sure to republish the translations.

If you referenced Mailcoach translations somewhere in your app, make sure to replace it by the new helper, the `mailcoach - ` prefix is no longer necessary:

```php
- {{ __('mailcoach - Some translation string') }}
+ {{ __mc('Some translation string') }}

- {{ trans_choice('mailcoach - One|More', 2) }}
+ {{ __mc_choice('One|More', 2) }}
```

### API

All API resources & endpoints now use `uuid`s instead of `id`s for references to models. Update your integrations with the API if necessary.

## Unlayer users

This version of Mailcoach uses an newer version of Unlayer. Your old templates might not be compatible. To make Unlayer templates compatible, you might try the code mentioned in [this issue](https://github.com/spatie/laravel-mailcoach/issues/1183). Also take look at [this issue](https://github.com/spatie/laravel-mailcoach/issues/1149)

If you still reference `Route::mailcoachUnlayer()` somewhere in project, you should remove it. 

